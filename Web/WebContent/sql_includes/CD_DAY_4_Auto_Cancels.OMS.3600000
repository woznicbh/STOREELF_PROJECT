 with details as(select  /*+parallel(8) full(tab) full(itemtab) */ tab.cancel_date,(case when fulfillment_type='Priority_Order' and extn_ship_node_source ='RDC' then 'RDCPriorityOrderCancel' when fulfillment_type ='Priority_Order' and line_type ='DSV' then 'DSVPriorityOrderCancel' when fulfillment_type ='Priority_Order' and extn_ship_node_source ='STORE' then 'StrPrityOrdCncl-NoInv' when fulfillment_type ='Priority_Order' then 'PriorityOrdercancel' When  carrier_service_code='Alaska/Hawaii APO/FPO' then 'APO/FPOcancel' when fulfillment_type ='Gift_Wrap' and carrier_service_code !='Priority Air' Then 'GiftWrapCancel' when line_type='DSV' then 'DSLineCancel' else 'RTAM/Genuinecancel' END  ) reason, sum(tab.cancelledqty) as cancelled_qty from (select /*+parallel(8) full(t3) full(t4) */ t3.cancel_date,T3.item_id,T3.cancelledqty , T3.fulfillment_type, T3.carrier_service_code,line_type from (select /*+parallel(8) full(t1) full(t2) */ t1.cancel_date as cancel_date, t1.orderdate,t2.order_no,t1.ship_to_key, t1.cancelledqty ,t1.item_id,t1.fulfillment_type,t1.carrier_service_code, t2.customer_emailid,t1.line_type from (select  /*+parallel(8) full(ors) full(ol) */ TO_CHAR(ors.createts,'YYYY-MM-DD') as cancel_date,substr(ors.order_line_key,1,8) as orderdate,ol.order_header_key, ol.order_line_key,ship_to_key, coalesce((ol.original_ordered_qty - ol.ordered_qty),0) as cancelledqty ,item_id ,carrier_service_code,fulfillment_type ,ol.line_type from STERLING.yfs_order_release_status ors, sterling.yfs_order_line ol where ors.modifyprogid = 'SCHEDULE.0001' and ors.status = '9000' and not exists (select /*+parallel(8) full(r) */ 'x' from sterling.yfs_order_release_status r where r.order_header_key = ors.order_header_key and r.order_line_key = ors.order_line_key and r.status = '1400') and ol.order_line_key = ors.order_line_key and ors.order_header_key > TO_CHAR(SYSDATE-1  , 'YYYYMMDD') and ors.order_header_key < TO_CHAR(SYSDATE  , 'YYYYMMDD') )t1,sterling.yfs_order_header t2 where t2.order_header_key >TO_CHAR(SYSDATE -1  , 'YYYYMMDD')and t2.order_header_key < TO_CHAR(SYSDATE  , 'YYYYMMDD') and t1.order_header_key=t2.order_header_key ) T3,sterling.yfs_person_info T4 where T3.ship_to_key =T4.person_info_key ) Tab ,sterling.yfs_item itemtab where tab.item_id =itemtab.item_id group by tab.cancel_date,(case when fulfillment_type='Priority_Order' and extn_ship_node_source ='RDC' then 'RDCPriorityOrderCancel' when fulfillment_type ='Priority_Order' and line_type ='DSV' then 'DSVPriorityOrderCancel' when fulfillment_type ='Priority_Order' and extn_ship_node_source ='STORE' then 'StrPrityOrdCncl-NoInv' when fulfillment_type ='Priority_Order' then 'PriorityOrdercancel' When  carrier_service_code='Alaska/Hawaii APO/FPO' then 'APO/FPOcancel' when fulfillment_type ='Gift_Wrap' and carrier_service_code !='Priority Air' Then 'GiftWrapCancel' when line_type='DSV' then 'DSLineCancel' else 'RTAM/Genuinecancel' END ) union all (select /*+parallel(8) full(a) full(b) */ TO_CHAR(a.createts,'YYYY-MM-DD') AS CANCEL_DATE,reason_code as reason,sum(b.original_quantity-b.quantity) as cancelledqty from  sterling.yfs_shipment_status_audit a,sterling.yfs_shipment_line b   where a.shipment_key=b.shipment_key and shipment_status_audit_key >  TO_CHAR(SYSDATE-1 , 'YYYYMMDD') and shipment_status_audit_key <  TO_CHAR(SYSDATE , 'YYYYMMDD') and reason_code ='Auto-Cancel At Print' group by TO_CHAR(a.createts,'YYYY-MM-DD'),reason_code) ) select * from (select /*+parallel(8) full(details) */ cancel_date,reason,cancelled_qty from details) pivot( MIN (cancelled_qty) for reason in ('RDCPriorityOrderCancel', 'DSVPriorityOrderCancel', 'StrPrityOrdCncl-NoInv', 'PriorityOrdercancel', 'APO/FPOcancel', 'GiftWrapCancel' , 'RTAM/Genuinecancel' , 'Auto-Cancel At Print','DSLineCancel') ) order by 1 